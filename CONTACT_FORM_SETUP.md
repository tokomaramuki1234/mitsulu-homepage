# お問い合わせフォーム完全セットアップガイド

## 📋 目次

1. [概要](#概要)
2. [システム構成](#システム構成)
3. [セットアップ手順](#セットアップ手順)
4. [SPFレコード設定](#spfレコード設定)
5. [動作テスト手順](#動作テスト手順)
6. [トラブルシューティング](#トラブルシューティング)
7. [よくある質問](#よくある質問)

---

## 概要

### 実装されている機能

- ✅ **React フロントエンド** - Next.js コンポーネントによるフォームUI
- ✅ **PHP バックエンド** - Xserver でのメール送信処理
- ✅ **管理者通知メール** - mk@mitsulu.style へ送信
- ✅ **自動返信メール** - 送信者への確認メール
- ✅ **バリデーション** - 入力チェック・サニタイズ処理
- ✅ **エラーハンドリング** - 詳細なエラーログ
- ✅ **CORS対応** - Vercel → Xserver のクロスドメイン通信

### 技術スタック

| レイヤー | 技術 | ホスティング |
|---------|------|------------|
| フロントエンド | React (Next.js) | Vercel |
| バックエンド | PHP 8.x | Xserver |
| メール送信 | mb_send_mail() | Xserver |
| DNS管理 | - | Xserver |

---

## システム構成

```
┌─────────────────────────────────────────┐
│   ユーザー（ブラウザ）                    │
└─────────────────────────────────────────┘
         │
         │ ① フォーム入力・送信
         ↓
┌─────────────────────────────────────────┐
│   React フロントエンド                    │
│   https://mitsulu.style/#contact        │
│   (Vercel)                              │
│   - ContactSection.tsx                  │
│   - バリデーション（クライアント側）       │
└─────────────────────────────────────────┘
         │
         │ ② POST リクエスト (JSON)
         │    https://form.mitsulu.style/contact.php
         ↓
┌─────────────────────────────────────────┐
│   PHP バックエンド                        │
│   https://form.mitsulu.style/contact.php│
│   (Xserver)                             │
│   - CORS設定                            │
│   - バリデーション（サーバー側）           │
│   - データサニタイズ                     │
└─────────────────────────────────────────┘
         │
         │ ③ メール送信
         ↓
┌─────────────────────────────────────────┐
│   Xserver メールサーバー                  │
│   - 管理者メール: mk@mitsulu.style      │
│   - 自動返信: noreply@mitsulu.style     │
└─────────────────────────────────────────┘
```

---

## セットアップ手順

### ステップ1: Xserver メールアカウント確認

✅ **既に完了済み** - `noreply@mitsulu.style` 作成済み

確認方法：
1. Xserver サーバーパネルにログイン
2. 「メールアカウント設定」を開く
3. `noreply@mitsulu.style` が存在することを確認

---

### ステップ2: contact.php のアップロード

#### 2-1. FileZilla でXserverに接続

**接続情報**：
- **ホスト**: `mitsulu.style` のFTPホスト（Xserverサーバーパネルで確認）
- **ユーザー名**: Xserver FTPアカウント
- **パスワード**: Xserver FTPパスワード
- **ポート**: 21 (FTP) または 22 (SFTP推奨)

#### 2-2. ファイルをアップロード

**アップロード元**:
```
ローカル: C:\Users\Endeavor\Documents\009-三流\mitsulu-web\mitsulu-homepage\contact.php
```

**アップロード先**:
```
Xserver: /mitsulu.style/public_html/form/contact.php
```

**手順**:
1. FileZilla で Xserver に接続
2. 右側ペイン（リモート側）で `/mitsulu.style/public_html/form/` に移動
3. 左側ペイン（ローカル側）で `contact.php` を選択
4. 右クリック → 「アップロード」
5. パーミッション設定: `644` (読み取り: 全員、書き込み: 所有者のみ)

#### 2-3. パーミッション設定

FileZilla でファイルを右クリック → 「ファイルのパーミッション」

```
所有者: 読み取り(4) + 書き込み(2) = 6
グループ: 読み取り(4) = 4
その他: 読み取り(4) = 4
```

**数値**: `644`

---

### ステップ3: DNS設定確認

既に設定済みですが、念のため確認：

#### Xserver DNS レコード

| ホスト名 | 種別 | 値 | 用途 |
|----------|------|----|------|
| `@` | A | `216.198.79.1` | Vercel (メインサイト) |
| `www` | CNAME | `db6751fc8be97914.vercel-dns-017.com` | Vercel (www) |
| `form` | A | Xserver IP | **フォームAPI** |

**確認方法**:
1. Xserver サーバーパネル → 「DNSレコード設定」
2. `mitsulu.style` を選択
3. 上記レコードが存在することを確認

---

### ステップ4: React コンポーネント確認

既に実装済み：

- `components/ContactSection.tsx` - フォームUI
- `styles/Home.module.css` - CSS スタイル

変更内容：
- エラーハンドリング改善
- 成功時メッセージの詳細化
- スクロール位置調整

---

### ステップ5: GitHub プッシュ → Vercel デプロイ

```bash
# プロジェクトディレクトリに移動
cd "C:\Users\Endeavor\Documents\009-三流\mitsulu-web\mitsulu-homepage"

# 変更を確認
git status

# すべての変更をステージング
git add .

# コミット
git commit -m "Add complete contact form with PHP backend

- Update ContactSection.tsx with improved error handling
- Update contact.php with detailed logging and auto-reply
- Add CSS styles for success message and new inquiry button
- Add CONTACT_FORM_SETUP.md documentation"

# GitHub にプッシュ
git push origin main
```

**Vercel 自動デプロイ確認**:
1. https://vercel.com/dashboard にアクセス
2. `mitsulu-homepage` プロジェクトを開く
3. 「Deployments」タブでビルド状況を確認
4. 2〜5分後にデプロイ完了

---

## SPFレコード設定

### SPFレコードとは？

**SPF (Sender Policy Framework)** は、メール送信元の正当性を証明する仕組みです。
SPFレコードを設定することで、送信したメールが迷惑メールと判定されにくくなります。

### 現状確認

現在、`noreply@mitsulu.style` からメールを送信していますが、SPFレコードが未設定のため、
受信側のメールサーバーで迷惑メール判定される可能性があります。

### 設定手順

#### ステップ1: Xserver サーバーパネルにアクセス

1. Xserver サーバーパネルにログイン
2. 「DNSレコード設定」をクリック
3. `mitsulu.style` を選択

#### ステップ2: SPFレコードを追加

「DNSレコード追加」タブを開き、以下の設定を追加：

| 項目 | 値 |
|------|-----|
| **ホスト名** | `@` (空欄またはルートドメイン) |
| **種別** | `TXT` |
| **内容** | `v=spf1 +a +mx include:_spf.xserver.jp ~all` |
| **優先度** | （空欄） |

**設定値の意味**:
- `v=spf1` - SPFバージョン1を使用
- `+a` - ドメインのAレコードに指定されたIPアドレスからの送信を許可
- `+mx` - ドメインのMXレコードに指定されたサーバーからの送信を許可
- `include:_spf.xserver.jp` - Xserver の SPF レコードを継承
- `~all` - それ以外は「ソフトフェイル」（疑わしいが受け取る）

#### ステップ3: 設定を保存

「確認画面へ進む」→ 「追加する」をクリック

#### ステップ4: 反映確認（24〜48時間後）

**コマンドラインで確認** (Windows PowerShell):
```powershell
nslookup -type=txt mitsulu.style
```

**または Web ツールで確認**:
- https://mxtoolbox.com/spf.aspx
- `mitsulu.style` を入力して「SPF Record Lookup」

**正常な出力例**:
```
mitsulu.style  text = "v=spf1 +a +mx include:_spf.xserver.jp ~all"
```

---

### DKIM設定（オプション・推奨）

さらにメール到達率を向上させたい場合、DKIM（DomainKeys Identified Mail）も設定推奨：

#### Xserver での DKIM 設定

1. Xserver サーバーパネル → 「メール設定」
2. 「DKIM設定」を開く
3. `mitsulu.style` を選択
4. 「DKIM を有効にする」

Xserver が自動的に DKIM レコードを DNS に追加します。

---

## 動作テスト手順

### テスト1: ローカル開発環境でのテスト

#### 1-1. 開発サーバー起動

```bash
cd "C:\Users\Endeavor\Documents\009-三流\mitsulu-web\mitsulu-homepage"
npm run dev
```

ブラウザで http://localhost:3000/#contact にアクセス

#### 1-2. フォーム入力テスト

**テストデータ**:
- **お名前**: テスト太郎
- **メールアドレス**: 自分の実際のメールアドレス
- **電話番号**: 090-1234-5678
- **会社名**: テスト株式会社
- **お問い合わせ種類**: Web構築・開発・運用
- **お問い合わせ内容**: テスト送信です。

#### 1-3. 送信ボタンをクリック

**期待される動作**:
- 送信中表示: 「送信中...」
- 成功表示: 「お問い合わせありがとうございます」
- エラーがないこと

#### 1-4. メール受信確認

**確認ポイント**:
1. **mk@mitsulu.style** に管理者通知メールが届く
2. **入力したメールアドレス** に自動返信メールが届く
3. 件名・本文が正しい

**届かない場合**:
- 迷惑メールフォルダを確認
- 数分待ってから再確認

---

### テスト2: 本番環境でのテスト

#### 2-1. GitHub プッシュ後、Vercel デプロイ完了を確認

https://vercel.com/dashboard で「Ready」になるまで待つ

#### 2-2. 本番サイトにアクセス

https://mitsulu.style/#contact

#### 2-3. フォーム送信テスト

上記と同じテストデータで送信

#### 2-4. 動作確認チェックリスト

- [ ] フォームが正常に表示される
- [ ] すべてのフィールドが入力できる
- [ ] バリデーションエラーが適切に表示される（必須項目を空欄にした場合）
- [ ] 送信ボタンをクリックして送信中表示が出る
- [ ] 送信完了メッセージが表示される
- [ ] 管理者メールが mk@mitsulu.style に届く
- [ ] 自動返信メールが送信者に届く
- [ ] スマホ表示で問題なく動作する（レスポンシブ確認）

---

### テスト3: エラーケースのテスト

#### 3-1. バリデーションエラー

**テストケース**:
1. 必須項目を空欄にして送信 → エラーメッセージ表示
2. 不正なメールアドレス形式（例: `test@`） → エラーメッセージ表示
3. 非常に長い文字列を入力 → サーバー側で切り詰められる

#### 3-2. ネットワークエラー

contact.php を一時的に削除 → 「通信エラーが発生しました」表示

---

### テスト4: メール内容の確認

#### 管理者通知メール（mk@mitsulu.style）

**件名**: `【三流】お問い合わせ - (選択したカテゴリ)`

**本文**:
```
三流のWebサイトからお問い合わせがありました。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ お名前
テスト太郎

■ メールアドレス
test@example.com

■ 電話番号
090-1234-5678

■ 会社名・団体名
テスト株式会社

■ お問い合わせ種類
Web構築・開発・運用

■ お問い合わせ内容
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
テスト送信です。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

---
送信日時: 2025年10月24日 12時34分56秒
送信元IP: xxx.xxx.xxx.xxx
User-Agent: Mozilla/5.0...
```

#### 自動返信メール（送信者）

**件名**: `【三流】お問い合わせを受け付けました`

**本文**:
```
テスト太郎 様

この度は三流（Mitsulu）にお問い合わせいただき、誠にありがとうございます。
以下の内容でお問い合わせを受け付けました。
24時間以内に担当者よりご連絡いたしますので、今しばらくお待ちください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【お問い合わせ内容の確認】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【お名前】
テスト太郎

【メールアドレス】
test@example.com

【電話番号】
090-1234-5678

【会社名・団体名】
テスト株式会社

【お問い合わせ種類】
Web構築・開発・運用

【お問い合わせ内容】
テスト送信です。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 注意事項

・このメールは自動送信されています。このメールへの返信は受け付けておりません。
・担当者から改めてご連絡いたしますので、今しばらくお待ちください。
・迷惑メールフォルダに振り分けられる場合がございます。
  メールが届かない場合は、迷惑メールフォルダをご確認ください。
・メールアドレスに誤りがあった場合、ご連絡できない可能性がございます。
  その際は再度お問い合わせください。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
三流（Mitsulu）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

小さな組織の手が回らないお困りごとを横断的に解決するIT系の何でも屋さん

【公式サイト】
https://mitsulu.style

【お問い合わせ】
mk@mitsulu.style

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## トラブルシューティング

### 問題1: メールが届かない

#### 原因と対策

**1. 迷惑メールフォルダに入っている**
- → 迷惑メールフォルダを確認
- → SPFレコードを設定（上記参照）

**2. contact.php がアップロードされていない**
- → FileZilla で `/mitsulu.style/public_html/form/contact.php` が存在するか確認

**3. パーミッションが間違っている**
- → FileZilla で `644` に設定

**4. Xserver のメール送信制限**
- → 短時間に大量送信した場合、一時的に制限される可能性あり
- → 30分〜1時間待ってから再試行

**5. noreply@mitsulu.style が存在しない**
- → Xserver サーバーパネル → 「メールアカウント設定」で確認・作成

---

### 問題2: 送信ボタンを押してもエラーになる

#### 原因と対策

**1. CORS エラー**

ブラウザのコンソール（F12）で以下のエラーが出ている：
```
Access to fetch at 'https://form.mitsulu.style/contact.php' from origin 'https://mitsulu.style' has been blocked by CORS policy
```

**対策**:
- contact.php の CORS 設定を確認
- `Access-Control-Allow-Origin: https://mitsulu.style` が正しく設定されているか

**2. DNSが反映されていない**

```powershell
nslookup form.mitsulu.style
```

Xserver の IP アドレスが返ってくるか確認

**3. PHPのエラー**

contact.php に構文エラーがある場合：
- → Xserver のエラーログを確認（サーバーパネル → 「ログファイル」）

---

### 問題3: フォームは送信できるが、メール本文が文字化けする

#### 原因

PHP の文字コード設定が UTF-8 になっていない

#### 対策

contact.php の先頭に以下を追加（既に記載済み）:
```php
header('Content-Type: application/json; charset=utf-8');
```

mb_send_mail() のヘッダーに UTF-8 を指定（既に記載済み）:
```php
$headers = "Content-Type: text/plain; charset=UTF-8\r\n";
```

---

### 問題4: 自動返信メールが届かない（管理者メールは届く）

#### 原因

自動返信の送信先メールアドレスが不正、またはメールサーバー側の問題

#### 対策

1. 入力したメールアドレスが正しいか確認
2. Gmail / Outlook などの大手メールサービスでテスト
3. Xserver のエラーログを確認

---

## よくある質問

### Q1: 1日に送信できるメール数の制限はありますか？

**A1**: Xserver のメール送信制限は以下の通りです：

- **1時間あたり**: 約1,500通
- **1日あたり**: 約15,000通

通常のお問い合わせフォームでは十分な数です。
ただし、スパム攻撃を受けた場合は、reCAPTCHA の導入を推奨します。

---

### Q2: contact.php のログはどこで確認できますか?

**A2**: Xserver のエラーログで確認できます：

1. Xserver サーバーパネル → 「ログファイル」
2. 「エラーログ」を選択
3. 最新のログを確認

**または、contact.php に以下を追加してログファイルに出力**:
```php
error_log($log_message, 3, '/home/xserver_user/mitsulu.style/log/contact.log');
```

---

### Q3: テスト送信したメールを削除したい

**A3**:
- Gmail: 迷惑メールに移動 → 30日後に自動削除
- Xserver Webメール: メールを選択 → 削除

---

### Q4: フォームに reCAPTCHA を追加したい

**A4**: 将来的に追加する場合の手順：

1. Google reCAPTCHA v3 を取得
2. React コンポーネントに reCAPTCHA トークン追加
3. contact.php でトークン検証

詳細は別途ドキュメント作成可能です。

---

### Q5: メールの From アドレスを変更したい

**A5**: contact.php の以下の行を変更：

```php
// 変更前
$from = 'noreply@mitsulu.style';

// 変更後（例）
$from = 'info@mitsulu.style';
```

変更後は、Xserver でそのメールアカウントを作成する必要があります。

---

## セットアップ完了チェックリスト

すべてチェックが入れば完了です！

### Xserver 設定
- [ ] `noreply@mitsulu.style` メールアカウント作成済み
- [ ] contact.php を `/mitsulu.style/public_html/form/` にアップロード済み
- [ ] パーミッション `644` に設定済み
- [ ] DNS レコード `form` (A レコード) が設定済み
- [ ] SPF レコード設定済み（推奨）

### フロントエンド
- [ ] ContactSection.tsx 更新済み
- [ ] CSS スタイル追加済み
- [ ] GitHub にプッシュ済み
- [ ] Vercel デプロイ完了

### 動作確認
- [ ] ローカル環境でテスト送信成功
- [ ] 本番環境でテスト送信成功
- [ ] 管理者メール受信確認（mk@mitsulu.style）
- [ ] 自動返信メール受信確認
- [ ] スマホ表示確認
- [ ] バリデーションエラー表示確認

---

## サポート

### 問題が解決しない場合

1. このドキュメントの「トラブルシューティング」を確認
2. Xserver サポートに問い合わせ（メール送信関連）
3. ブラウザのコンソール（F12）でエラー確認

### 技術的な質問

- Xserver 公式サポート: https://www.xserver.ne.jp/support/
- Next.js 公式ドキュメント: https://nextjs.org/docs

---

**作成日**: 2025-10-24
**最終更新**: 2025-10-24
**バージョン**: 1.0.0
